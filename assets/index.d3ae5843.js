import{a7 as se,b6 as R,r as f,m as le,a as d,F as b,j as r,aK as ne,B as j,T as pe,bj as Z,R as ue,C as L,bk as me,bl as Fe,c0 as he,aY as ee,L as re,M as ie,bn as ye,c1 as ge,c2 as Ce,b as be,u as Ae,J as Ee,aU as ve,D as Be,c3 as De}from"./index.e1f6c22a.js";import{g as Ie,c as Ne,d as Se,e as we}from"./ability.05d1734c.js";import{d as $,D as xe}from"./zh-cn.0ce3a149.js";import{T as Ve,C as Le}from"./Table.d58b7c0e.js";import{U as ke}from"./UploadOutlined.729c023c.js";import{R as te}from"./index.8acb433e.js";import{A as oe}from"./index.e7233328.js";import"./useBreakpoint.d0306603.js";import"./Pagination.f3bb0a48.js";import"./index.ccade529.js";const Te="_header_14dp7_1",Pe="_name_14dp7_6",Ue="_mask_14dp7_21",k={header:Te,name:Pe,"form-tabs":"_form-tabs_14dp7_17",mask:Ue},ae=se.forwardRef(({formId:S,formList:B},A)=>{const[c]=R.useForm(),D={labelCol:{span:4},wrapperCol:{span:12},autoComplete:"off"};f.exports.useEffect(()=>{(async()=>{const e={},a={},s={},t=B.reduce((u,l)=>{l.type==="privateKey"&&l.value?e[l.field]={publicKey:l.value}:["imageUpload"].includes(l.type)?a[l.field]=l.value:["fileUpload"].includes(l.type)&&(s[l.field]=l.value);let n=l.value;return l.type==="dateTime"&&l.value?n=$(l.value):l.type==="switch"&&!l.value&&(n=!1),{...u,[l.field]:n}},{});w(e),T(a),C(s),c.setFieldsValue(t)})()},[]);const[p,T]=f.exports.useState({}),P=(e,a)=>{new Promise(s=>{ye(e.file,t=>{s(t)})}).then(s=>{const t=s.substring(s.indexOf("base64,")+7),{file:u}=e,l=new FormData;l.append("file",u);const n={uid:e.file.uid,name:e.file.name,status:"done",url:`data:image/png;base64,${t}`,file:l};c.setFieldValue(a,p[a]?[...p[a],n]:[n]),T({...p,[a]:p[a]?[...p[a],n]:[n]})})},G=(e,a)=>{const{uid:s}=e;return c.setFieldValue(a,p[a].filter(t=>t.uid!==s)),T({...p,[a]:p[a].filter(t=>t.uid!==s)}),!1},[i,O]=f.exports.useState(!1),[M,z]=f.exports.useState(),E=e=>{z(e.url),O(!0)},[H,_]=le.useMessage(),[F,C]=f.exports.useState({}),W=(e,a)=>{if(a.ruleList.includes("all"))return!0;const{name:s}=e,t=s.substring(s.lastIndexOf(".")+1),u=a.ruleList.includes(t);return u||H.error(`\u4E0D\u652F\u6301\u4E0A\u4F20${t}\u683C\u5F0F\u6587\u4EF6`),u||Z.LIST_IGNORE},Q=async(e,a)=>{const{file:s}=e,t=new FormData;t.append("file",s);const u={uid:e.file.uid,name:e.file.name,status:"done",url:"",file:t};c.setFieldValue(a,F[a]?[...F[a],u]:[u]),C({...F,[a]:F[a]?[...F[a],u]:[u]})},K=(e,a)=>{const{uid:s}=e;return c.setFieldValue(a,F[a].filter(t=>t.uid!==s)),C({...F,[a]:F[a].filter(t=>t.uid!==s)}),!1},[U,w]=f.exports.useState({}),x=async e=>{const{data:a}=await ge();if(!a)return;const{publicKey:s,privateKey:t}=a;w({...U,[e]:{publicKey:s,privateKey:t}}),c.setFieldValue(e,s);const u=`\u516C\u94A5\uFF1A${s}
\u79C1\u94A5\uFF1A${t}`;Ce(u,"\u5BC6\u94A5\u5BF9")},[I,V]=f.exports.useState();f.exports.useEffect(()=>{const e=B.find(s=>s.type==="table");if(!e)return;const a=e.tableOptions.map((s,t)=>{const u=e.value&&e.value[t];return{...s,value:u==null?void 0:u.value}});V(a)},[]);const q=(e,a)=>{const{id:s}=a,t={id:s,value:e},u=I.findIndex(n=>n.id===s);if(u===-1)return;const l=c.getFieldValue("upEndTime");if(l)l[u]=t,c.setFieldValue("upEndTime",l);else{const n=Array(I==null?void 0:I.length);n[u]=t,c.setFieldValue("upEndTime",n)}},o=[{title:"\u63A5\u53E3\u540D\u79F0",width:200,dataIndex:"key"},{title:"\u8C03\u7528\u5E76\u53D1\u4E0A\u9650\uFF08\u6BCF\u79D2\u5E76\u53D1\uFF09",render:e=>r(b,{children:r(ee,{defaultValue:e.value,placeholder:"\u8BF7\u9009\u62E9\u8C03\u7528\u5E76\u53D1\u4E0A\u9650\uFF08\u6BCF\u79D2\u5E76\u53D1\uFF09",options:e.options,onChange:a=>q(a,e)})})}];return d(b,{children:[_,r(R,{ref:A,form:c,name:S.toString(),...D,children:B.map(e=>r(se.Fragment,{children:e.cnName!=="\u63A5\u5165\u80FD\u529B\u6709\u6548\u671F\u6B62"&&r(R.Item,{noStyle:["imageUpload","fileUpload"].includes(e.type),name:["imageUpload","fileUpload"].includes(e.type)?void 0:e.field,label:!["imageUpload","fileUpload"].includes(e.type)&&e.cnName,rules:[{required:e.required,message:`${["dateTime","radio","checkbox","select","selectMultiple","table"].includes(e.type)?"\u8BF7\u9009\u62E9":"\u8BF7\u8F93\u5165"}${e.cnName}`},{validator(a,s){return e.type==="table"&&s&&s.some(u=>!u)?Promise.reject(new Error("\u8BF7\u5F55\u5165\u6240\u6709\u8C03\u7528\u5E76\u53D1\u4E0A\u9650")):Promise.resolve()}}],valuePropName:["switch","checkbox"].includes(e.type)?"checked":void 0,children:(()=>{var a,s,t;switch(e.type){case"text":return r(re,{placeholder:e.placeholder,maxLength:e.maxLength,showCount:!0});case"textarea":return r(re.TextArea,{placeholder:e.placeholder,maxLength:e.maxLength,showCount:!0});case"dateTime":return r(xe,{style:{minWidth:160},placeholder:e.placeholder});case"radio":return r(te.Group,{options:e.options||[]});case"checkbox":return r(Le.Group,{options:e.options||[],defaultValue:e.value});case"select":return r(ee,{options:e.options||[],placeholder:e.placeholder});case"selectMultiple":return r(ee,{mode:"multiple",allowClear:!0,options:e.options||[],placeholder:e.placeholder});case"switch":return r(he,{options:e.options||[],placeholder:e.placeholder,checkedChildren:(a=e.switchText)==null?void 0:a.split("/")[0],unCheckedChildren:(s=e.switchText)==null?void 0:s.split("/")[1]});case"imageUpload":return d(b,{children:[r(R.Item,{name:e.field,label:e.cnName,style:{marginBottom:0},rules:[{required:e.required,message:`\u8BF7\u8865\u5145${e.cnName}`}],children:r(Z,{listType:"picture-card",maxCount:1,fileList:p[e.field],beforeUpload:u=>me(u,e.fileSize),customRequest:u=>P(u,e.field),onPreview:E,onRemove:u=>G(u,e.field),children:(!p[e.field]||e.multiple>p[e.field].length)&&d(b,{children:[r(Fe,{}),"\u9009\u62E9\u56FE\u7247"]})})}),d(ue,{children:[r(L,{span:20,offset:4,className:"font-secondary-color",children:"\u4E0A\u4F20\u56FE\u7247\u53EA\u5141\u8BB8JPG/PNG\u683C\u5F0F"}),d(L,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u56FE\u7247\u6587\u4EF6\u5927\u5C0F\uFF1A",e.fileSize,"M"]}),d(L,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u4E0A\u4F20\u56FE\u7247\u6570\u91CF\uFF1A",e.multiple,"\u5F20"]})]})]});case"fileUpload":return d(b,{children:[r(R.Item,{name:e.field,label:e.cnName,style:{marginBottom:0},rules:[{required:e.required,message:`\u8BF7\u8865\u5145${e.cnName}`}],children:r(Z,{maxCount:1,fileList:F[e.field],beforeUpload:u=>W(u,e),customRequest:u=>Q(u,e.field),onRemove:u=>K(u,e.field),children:r(j,{icon:r(ke,{}),disabled:F[e.field]&&e.multiple<=F[e.field].length,children:"\u4E0A\u4F20\u6587\u4EF6"})})}),d(ue,{children:[r(L,{span:20,offset:4,className:"font-secondary-color",children:!e.ruleList.includes("all")&&`\u4E0A\u4F20\u6587\u4EF6\u53EA\u5141\u8BB8${e.ruleList.join()}\u683C\u5F0F`}),d(L,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u6587\u4EF6\u5927\u5C0F\uFF1A",e.fileSize,"M"]}),d(L,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u4E0A\u4F20\u6587\u4EF6\u6570\u91CF\uFF1A",e.multiple]})]})]});case"privateKey":return d(ne,{children:[r(j,{type:"primary",onClick:()=>x(e.field),children:"\u751F\u6210\u5BC6\u94A5\u5BF9"}),U&&d(b,{children:[r("span",{style:{minWidth:50,display:"inline-block"},children:"\u516C\u94A5\uFF1A"}),r(pe.Paragraph,{copyable:!0,style:{marginBottom:0},children:(t=U[e.field])==null?void 0:t.publicKey})]})]});case"table":return r(b,{children:r(Ve,{rowKey:"id",bordered:!0,dataSource:I,columns:o,pagination:!1})});default:return r(b,{})}})()})},e.field))}),r(ie,{open:i,footer:null,onCancel:()=>O(!1),children:r("img",{alt:"image",style:{width:"100%"},src:M})})]})});ae.displayName="DynamicForm";const Ge=()=>{const[S]=be(),B=Ae(),A=S.get("appId"),c=Number(S.get("capabilityId")),D=S.get("env"),p=!!S.get("isEdit");if(!A||!c||!D)return B(-1);const{myAppStore:T}=Ee();T.setAppId(A);const[P,G]=f.exports.useState(),[i,O]=f.exports.useState(),[M,z]=f.exports.useState(),E=f.exports.useRef();f.exports.useEffect(()=>{(async()=>{const{data:o}=await Ie({id:c});G(o)})(),(async()=>{const{data:o}=await Ne({appId:A,capabilityId:c,env:D});if(!o)return B(-1);O(o.formList),z(JSON.parse(o.formList[0].defaultFormContent)),_(o.formList[0].formId)})()},[]);const[H,_]=f.exports.useState(0),F=o=>{const e=i.find(a=>a.formId===o.target.value);!e||_(e.formId)},C=f.exports.useRef([]),[W,Q]=ie.useModal(),[K,U]=le.useMessage(),w=(o,e)=>{const{type:a}=o;if(e=e||o.value,["radio","select"].includes(a)){const{options:s}=o;if(!s)return;const t=s.find(u=>u.value===e);return t==null?void 0:t.label}else if(["checkbox","selectMultiple"].includes(a)){const{options:s}=o;if(!s)return;const t=(e==null?void 0:e.reduce((u,l)=>{const n=s.find(h=>h.value===l),g=n?n.label:void 0;return[...u,g]},[]))||void 0;return t?t.toString():void 0}else{if(["dateTime"].includes(a)&&e)return $(e).isValid()&&$(e).format("YYYY-MM-DD");if(["switch"].includes(a)){const{switchText:s}=o;return s?(s==null?void 0:s.split("/"))[+!e]:void 0}else return["table"].includes(a)?o.tableOptions.map((s,t)=>({label:s.key,value:e&&e[t]?e[t].value:void 0})):e}},x=(o,e)=>o==="dateTime"&&e&&$(e).isValid()?$(e).format("YYYY-MM-DD"):e,[I,V]=f.exports.useState(!1),q=async o=>{if(!await W.confirm({title:`${o?"\u63D0\u4EA4\u5BA1\u6838":"\u4FDD\u5B58\u8349\u7A3F"}`,content:`${o?"\u63D0\u4EA4\u5BA1\u6838\u540E\u4F1A\u8FDB\u5165\u5BA1\u6279\u9636\u6BB5\uFF0C\u8BF7\u786E\u8BA4\u662F\u5426\u63D0\u4EA4":"\u4FDD\u5B58\u8349\u7A3F\u4F1A\u8986\u76D6\u4E0A\u4E00\u6B21\u4FDD\u5B58\u7684\u5185\u5BB9\uFF0C\u662F\u5426\u786E\u8BA4\u4FDD\u5B58\uFF1F"}`})||(V(!0),!i))return;if(o)try{await E.current.validateFields();for(let t=0;t<C.current.length;t++)await C.current[t].validateFields()}catch{return K.error("\u8BF7\u6838\u5BF9\u8868\u5355\u5FC5\u586B\u9879\u662F\u5426\u5DF2\u5168\u90E8\u5F55\u5165"),V(!1),!1}const a=[];for(let t=0;t<(i==null?void 0:i.length);t++){const u=JSON.parse(i[t].formContent),l=[];for(let g=0;g<u.length;g++){const{type:h}=u[g],m={...u[g]};if(["imageUpload","fileUpload"].includes(h)){const y=C.current[t].getFieldValue(u[g].field);if(!y)m.value=void 0;else{const N=[];for(let v=0;v<y.length;v++){const{file:J,status:Y,...ce}=y[v];if(Y==="done")if(J)try{const{data:X}=await De(J);if(!X)return;const{url:de}=X,fe={status:Y,...ce,url:de};N.push(fe)}catch{V(!1)}else N.push(y[v])}m.value=N}}else m.value=x(h,C.current[t].getFieldValue(u[g].field));l.push(m)}let n={formContent:JSON.stringify(l),formId:i[t].formId,formName:i[t].formName};if(t===0){const h=JSON.parse(i[0].defaultFormContent).map(m=>({...m,labelValue:w(m,E.current.getFieldValue(m.field)),value:x(m.type,E.current.getFieldValue(m.field))}));n.defaultFormContent=JSON.stringify(h)}if(o){const g=l.map(h=>{const{cnName:m,dataType:y,type:N,field:v}=h;return{cnName:m,dataType:y,type:N,field:v,labelValue:w(h),value:x(h.type,h.value)}});if(t===0){const m=JSON.parse(i[0].defaultFormContent).map(y=>{const{cnName:N,dataType:v,type:J,field:Y}=y;return{cnName:N,dataType:v,type:J,field:Y,labelValue:w(y,E.current.getFieldValue(y.field)),value:x(y.type,E.current.getFieldValue(y.field))}});n.defaultFormList=m}n={...n,form:g}}a.push(n)}const s={appId:A,capabilityId:c,formList:a,type:o,env:D};p?await we(s):await Se(s),V(!1),K.success({content:`\u5DF2\u6210\u529F${o?"\u63D0\u4EA4\u5BA1\u6838":"\u4FDD\u5B58\u8349\u7A3F"}`,duration:2,onClose:()=>B(`..?appId=${A}&capabilityId=${c}&env=${D}`)})};return d(b,{children:[Q,U,r("div",{className:k.mask,style:{display:I?"flex":"none"},children:r(ve,{size:"large"})}),d("div",{className:k.header,children:[r("div",{className:`${k["left-side"]} ${k.name}`,children:P==null?void 0:P.name}),r("div",{className:k["right-side"],children:r(oe,{offsetTop:80,children:d(ne,{children:[!p&&r(j,{onClick:()=>q(0),children:"\u4FDD\u5B58\u8349\u7A3F"}),r(j,{type:"primary",onClick:()=>q(1),children:"\u63D0\u4EA4\u5BA1\u6838"})]})})})]}),r(Be,{}),r("div",{className:k["form-tabs"],children:i&&!!i.length&&r(oe,{offsetTop:80,style:{display:"inline-block"},children:r(te.Group,{size:"large",defaultValue:i[0].formId,buttonStyle:"solid",onChange:F,children:i.map(o=>r(te.Button,{value:o.formId,children:o.formName},o.formId))})})}),A&&D&&c&&i&&!!i.length&&i.map((o,e)=>d("div",{style:{display:H===o.formId?"block":"none"},children:[!e&&M&&r(ae,{ref:E,formId:"defaultForm",formList:M}),r(ae,{ref:a=>C.current[e]=a,formId:o.formId,formList:JSON.parse(o.formContent)})]},o.formId))]})};export{Ge as default};
