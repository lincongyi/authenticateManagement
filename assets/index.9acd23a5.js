import{a7 as X,b6 as L,r as h,m as ue,a as p,F as C,j as r,aK as ae,B as M,T as le,bj as z,R as Z,C as S,bk as ne,bl as ie,c0 as ce,aY as H,L as ee,M as re,bn as de,c1 as fe,c2 as pe,c3 as Fe,b as me,u as he,J as ye,D as ge}from"./index.69846dde.js";import{g as Ce,c as be,d as Ae,e as Ee}from"./ability.17a41f83.js";import{d as k,D as Be}from"./zh-cn.a6b0641d.js";import{T as ve,C as De}from"./Table.930ef8ec.js";import{U as Ne}from"./UploadOutlined.67dbbd4b.js";import{R as W}from"./index.1cc26b9b.js";import{A as te}from"./index.e0058a3c.js";import"./useBreakpoint.ba81da52.js";import"./Pagination.46de689e.js";import"./index.e2480fb9.js";const Ie="_header_17cy8_1",we="_name_17cy8_6",T={header:Ie,name:we,"form-tabs":"_form-tabs_17cy8_17"},Q=X.forwardRef(({formId:w,formList:v},b)=>{const[d]=L.useForm(),D={labelCol:{span:4},wrapperCol:{span:12},autoComplete:"off"};h.exports.useEffect(()=>{(async()=>{const e=v.reduce((a,t)=>{t.type==="privateKey"&&t.value?N({...B,[t.field]:{publicKey:t.value}}):["imageUpload"].includes(t.type)?V({...F,[t.field]:t.value}):["fileUpload"].includes(t.type)&&g({...y,[t.field]:t.value});let u=t.value;return t.type==="dateTime"&&t.value?u=k(t.value):t.type==="switch"&&!t.value&&(u=!1),{...a,[t.field]:u}},{});d.setFieldsValue(e)})()},[]);const[F,V]=h.exports.useState({}),x=(e,a)=>{new Promise(t=>{de(e.file,u=>{t(u)})}).then(t=>{const u=t.substring(t.indexOf("base64,")+7),n={uid:e.file.uid,name:e.file.name,status:"done",url:`data:image/png;base64,${u}`};d.setFieldValue(a,F[a]?[...F[a],n]:[n]),V({...F,[a]:F[a]?[...F[a],n]:[n]})})},K=(e,a)=>{const{uid:t}=e;return d.setFieldValue(a,F[a].filter(u=>u.uid!==t)),V({...F,[a]:F[a].filter(u=>u.uid!==t)}),!1},[i,P]=h.exports.useState(!1),[R,_]=h.exports.useState(),A=e=>{_(e.url),P(!0)},[q,U]=ue.useMessage(),[y,g]=h.exports.useState({}),J=(e,a)=>{if(a.ruleList.includes("all"))return!0;const{name:t}=e,u=t.substring(t.lastIndexOf(".")+1),l=a.ruleList.includes(u);return l||q.error(`\u4E0D\u652F\u6301\u4E0A\u4F20${u}\u683C\u5F0F\u6587\u4EF6`),l||z.LIST_IGNORE};let E;const $=async(e,a)=>{const t=new FormData,{file:u}=e;t.append("file",u);try{const{data:l}=await fe(t),{fileName:n,url:f}=l;E={uid:e.file.uid,name:n,status:"done",url:f}}catch(l){console.log("error",l),E={uid:e.file.uid,name:e.file.name,status:"error",url:""}}finally{d.setFieldValue(a,y[a]?[...y[a],E]:[E]),g({...y,[a]:y[a]?[...y[a],E]:[E]})}},Y=(e,a)=>{const{uid:t}=e;return d.setFieldValue(a,y[a].filter(u=>u.uid!==t)),g({...y,[a]:y[a].filter(u=>u.uid!==t)}),!1},[B,N]=h.exports.useState(),O=async e=>{const{data:a}=await pe();if(!a)return;const{publicKey:t,privateKey:u}=a;N({...B,[e]:{publicKey:t,privateKey:u}}),d.setFieldValue(e,t);const l=`\u516C\u94A5\uFF1A${t}
\u79C1\u94A5\uFF1A${u}`;Fe(l,"\u5BC6\u94A5\u5BF9")},[s,o]=h.exports.useState();h.exports.useEffect(()=>{const e=v.find(t=>t.type==="table");if(!e)return;const a=e.tableOptions.map((t,u)=>{const l=e.value&&e.value[u];return{...t,value:l==null?void 0:l.value}});o(a)},[]);const m=(e,a)=>{const{id:t}=a,u={id:t,value:e},l=s.findIndex(f=>f.id===t);if(l===-1)return;const n=d.getFieldValue("upEndTime");if(n)n[l]=u,d.setFieldValue("upEndTime",n);else{const f=Array(s==null?void 0:s.length);f[l]=u,d.setFieldValue("upEndTime",f)}},c=[{title:"\u63A5\u53E3\u540D\u79F0",width:200,dataIndex:"key"},{title:"\u8C03\u7528\u5E76\u53D1\u4E0A\u9650\uFF08\u6BCF\u79D2\u5E76\u53D1\uFF09",render:e=>r(C,{children:r(H,{defaultValue:e.value,placeholder:"\u8BF7\u9009\u62E9\u8C03\u7528\u5E76\u53D1\u4E0A\u9650\uFF08\u6BCF\u79D2\u5E76\u53D1\uFF09",options:e.options,onChange:a=>m(a,e)})})}];return p(C,{children:[U,r(L,{ref:b,form:d,name:w.toString(),...D,children:v.map(e=>r(X.Fragment,{children:e.cnName!=="\u63A5\u5165\u80FD\u529B\u6709\u6548\u671F\u6B62"&&r(L.Item,{noStyle:["imageUpload","fileUpload"].includes(e.type),name:["imageUpload","fileUpload"].includes(e.type)?void 0:e.field,label:!["imageUpload","fileUpload"].includes(e.type)&&e.cnName,rules:[{required:e.required,message:`${["dateTime","radio","checkbox","select","selectMultiple","table"].includes(e.type)?"\u8BF7\u9009\u62E9":"\u8BF7\u8F93\u5165"}${e.cnName}`},{validator(a,t){return e.type==="table"&&t&&t.some(l=>!l)?Promise.reject(new Error("\u8BF7\u5F55\u5165\u6240\u6709\u8C03\u7528\u5E76\u53D1\u4E0A\u9650")):Promise.resolve()}}],valuePropName:["switch","checkbox"].includes(e.type)?"checked":void 0,children:(()=>{var a,t;switch(e.type){case"text":return r(ee,{placeholder:e.placeholder,maxLength:e.maxLength,showCount:!0});case"textarea":return r(ee.TextArea,{placeholder:e.placeholder,maxLength:e.maxLength,showCount:!0});case"dateTime":return r(Be,{style:{minWidth:160},placeholder:e.placeholder});case"radio":return r(W.Group,{options:e.options||[]});case"checkbox":return r(De.Group,{options:e.options||[],defaultValue:e.value});case"select":return r(H,{options:e.options||[],placeholder:e.placeholder});case"selectMultiple":return r(H,{mode:"multiple",allowClear:!0,options:e.options||[],placeholder:e.placeholder});case"switch":return r(ce,{options:e.options||[],placeholder:e.placeholder,checkedChildren:(a=e.switchText)==null?void 0:a.split("/")[0],unCheckedChildren:(t=e.switchText)==null?void 0:t.split("/")[1]});case"imageUpload":return p(C,{children:[r(L.Item,{name:e.field,label:e.cnName,style:{marginBottom:0},rules:[{required:e.required,message:`\u8BF7\u8865\u5145${e.cnName}`}],children:r(z,{listType:"picture-card",maxCount:1,fileList:F[e.field],beforeUpload:u=>ne(u,e.fileSize),customRequest:u=>x(u,e.field),onPreview:A,onRemove:u=>K(u,e.field),children:(!F[e.field]||e.multiple>F[e.field].length)&&p(C,{children:[r(ie,{}),"\u9009\u62E9\u56FE\u7247"]})})}),p(Z,{children:[r(S,{span:20,offset:4,className:"font-secondary-color",children:"\u4E0A\u4F20\u56FE\u7247\u53EA\u5141\u8BB8JPG/PNG\u683C\u5F0F"}),p(S,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u56FE\u7247\u6587\u4EF6\u5927\u5C0F\uFF1A",e.fileSize,"M"]}),p(S,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u4E0A\u4F20\u56FE\u7247\u6570\u91CF\uFF1A",e.multiple,"\u5F20"]})]})]});case"fileUpload":return p(C,{children:[r(L.Item,{name:e.field,label:e.cnName,style:{marginBottom:0},rules:[{required:e.required,message:`\u8BF7\u8865\u5145${e.cnName}`}],children:r(z,{maxCount:1,fileList:y[e.field],beforeUpload:u=>J(u,e),customRequest:u=>$(u,e.field),onRemove:u=>Y(u,e.field),children:r(M,{icon:r(Ne,{}),disabled:y[e.field]&&e.multiple<=y[e.field].length,children:"\u4E0A\u4F20\u6587\u4EF6"})})}),p(Z,{children:[r(S,{span:20,offset:4,className:"font-secondary-color",children:!e.ruleList.includes("all")&&`\u4E0A\u4F20\u6587\u4EF6\u53EA\u5141\u8BB8${e.ruleList.join()}\u683C\u5F0F`}),p(S,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u6587\u4EF6\u5927\u5C0F\uFF1A",e.fileSize,"M"]}),p(S,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u4E0A\u4F20\u6587\u4EF6\u6570\u91CF\uFF1A",e.multiple]})]})]});case"privateKey":return p(ae,{children:[r(M,{type:"primary",onClick:()=>O(e.field),children:"\u751F\u6210\u5BC6\u94A5\u5BF9"}),B&&p(C,{children:[r("span",{style:{minWidth:50,display:"inline-block"},children:"\u516C\u94A5\uFF1A"}),r(le.Paragraph,{copyable:!0,style:{marginBottom:0},children:B[e.field].publicKey})]})]});case"table":return r(C,{children:r(ve,{rowKey:"id",bordered:!0,dataSource:s,columns:c,pagination:!1})});default:return r(C,{})}})()})},e.field))}),r(re,{open:i,footer:null,onCancel:()=>P(!1),children:r("img",{alt:"image",style:{width:"100%"},src:R})})]})});Q.displayName="DynamicForm";const Oe=()=>{const[w]=me(),v=he(),b=w.get("appId"),d=Number(w.get("capabilityId")),D=w.get("env"),F=!!w.get("isEdit");if(!b||!d||!D)return v(-1);const{myAppStore:V}=ye();V.setAppId(b);const[x,K]=h.exports.useState(),[i,P]=h.exports.useState(),[R,_]=h.exports.useState(),A=h.exports.useRef();h.exports.useEffect(()=>{(async()=>{const{data:s}=await Ce({id:d});K(s)})(),(async()=>{const{data:s}=await be({appId:b,capabilityId:d,env:D});if(!s)return v(-1);P(s.formList),_(JSON.parse(s.formList[0].defaultFormContent)),U(s.formList[0].formId)})()},[]);const[q,U]=h.exports.useState(0),y=s=>{const o=i.find(m=>m.formId===s.target.value);!o||U(o.formId)},g=h.exports.useRef([]),[J,E]=re.useModal(),[$,Y]=ue.useMessage(),B=(s,o)=>{const{type:m}=s;if(["radio","select"].includes(m)){const{options:c}=s;if(!c)return;const e=c.find(a=>a.value===o);return e==null?void 0:e.label}else if(["checkbox","selectMultiple"].includes(m)){const{options:c}=s;if(!c)return;const e=(o==null?void 0:o.reduce((a,t)=>{const u=c.find(n=>n.value===t),l=u?u.label:void 0;return[...a,l]},[]))||void 0;return e?e.toString():void 0}else{if(["dateTime"].includes(m)&&o)return k(o).isValid()&&k(o).format("YYYY-MM-DD");if(["switch"].includes(m)){const{switchText:c}=s;return c?(c==null?void 0:c.split("/"))[+!o]:void 0}else return["table"].includes(m)?s.tableOptions.map((c,e)=>({label:c.key,value:o&&o[e]?o[e].value:void 0})):o}},N=(s,o)=>{if(s==="dateTime")return o&&k(o).isValid()?k(o).format("YYYY-MM-DD"):o;if(s==="fileUpload"&&o){const m=o.filter(c=>c.status==="done");return m.length?m:void 0}else return o},O=async s=>{if(!i)return;if(s)try{await A.current.validateFields();for(let e=0;e<g.current.length;e++)await g.current[e].validateFields()}catch{return $.error("\u8BF7\u6838\u5BF9\u8868\u5355\u5FC5\u586B\u9879\u662F\u5426\u5DF2\u5168\u90E8\u5F55\u5165"),!1}const o=[];for(let e=0;e<(i==null?void 0:i.length);e++){const a=JSON.parse(i[e].formContent),t=a.map(l=>({...l,value:N(l.type,g.current[e].getFieldValue(l.field))}));let u={formContent:JSON.stringify(t),formId:i[e].formId,formName:i[e].formName};if(e===0){const n=JSON.parse(i[0].defaultFormContent).map(f=>({...f,labelValue:B(f,A.current.getFieldValue(f.field)),value:N(f.type,A.current.getFieldValue(f.field))}));u.defaultFormContent=JSON.stringify(n)}if(s){const l=a.map(n=>{const{cnName:f,dataType:I,type:j,field:G}=n;return{cnName:f,dataType:I,type:j,field:G,labelValue:B(n,g.current[e].getFieldValue(n.field)),value:N(n.type,g.current[e].getFieldValue(n.field))}});if(e===0){const f=JSON.parse(i[0].defaultFormContent).map(I=>{const{cnName:j,dataType:G,type:se,field:oe}=I;return{cnName:j,dataType:G,type:se,field:oe,labelValue:B(I,A.current.getFieldValue(I.field)),value:N(I.type,A.current.getFieldValue(I.field))}});u.defaultFormList=f}u={...u,form:l}}o.push(u)}if(!await J.confirm({title:`${s?"\u63D0\u4EA4\u5BA1\u6838":"\u4FDD\u5B58\u8349\u7A3F"}`,content:`${s?"\u63D0\u4EA4\u5BA1\u6838\u540E\u4F1A\u8FDB\u5165\u5BA1\u6279\u9636\u6BB5\uFF0C\u8BF7\u786E\u8BA4\u662F\u5426\u63D0\u4EA4":"\u4FDD\u5B58\u8349\u7A3F\u4F1A\u8986\u76D6\u4E0A\u4E00\u6B21\u4FDD\u5B58\u7684\u5185\u5BB9\uFF0C\u662F\u5426\u786E\u8BA4\u4FDD\u5B58\uFF1F"}`}))return;const c={appId:b,capabilityId:d,formList:o,type:s,env:D};F?await Ee(c):await Ae(c),$.success({content:`\u5DF2\u6210\u529F${s?"\u63D0\u4EA4\u5BA1\u6838":"\u4FDD\u5B58\u8349\u7A3F"}`,duration:2,onClose:()=>v(`..?appId=${b}&capabilityId=${d}&env=${D}`)})};return p(C,{children:[E,Y,p("div",{className:T.header,children:[r("div",{className:`${T["left-side"]} ${T.name}`,children:x==null?void 0:x.name}),r("div",{className:T["right-side"],children:r(te,{offsetTop:80,children:p(ae,{children:[!F&&r(M,{onClick:()=>O(0),children:"\u4FDD\u5B58\u8349\u7A3F"}),r(M,{type:"primary",onClick:()=>O(1),children:"\u63D0\u4EA4\u5BA1\u6838"})]})})})]}),r(ge,{}),r("div",{className:T["form-tabs"],children:i&&!!i.length&&r(te,{offsetTop:80,style:{display:"inline-block"},children:r(W.Group,{size:"large",defaultValue:i[0].formId,buttonStyle:"solid",onChange:y,children:i.map(s=>r(W.Button,{value:s.formId,children:s.formName},s.formId))})})}),b&&D&&d&&i&&!!i.length&&i.map((s,o)=>p("div",{style:{display:q===s.formId?"block":"none"},children:[!o&&R&&r(Q,{ref:A,formId:"defaultForm",formList:R}),r(Q,{ref:m=>g.current[o]=m,formId:s.formId,formList:JSON.parse(s.formContent)})]},s.formId))]})};export{Oe as default};
