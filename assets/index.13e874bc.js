import{R as oe,F as P,r as h,m as te,a as f,d as A,j as a,b as ue,B as O,U as z,c as X,C as S,i as le,e as ne,c5 as ie,S as H,I as Z,M as re,bI as ce,c6 as de,c7 as fe,c8 as pe,b4 as me,aI as Fe,u as he}from"./index.da6df52f.js";import{a as ye,c as ge,d as Ce,e as be}from"./ability.9496a847.js";import{d as U,D as Ae}from"./zh-cn.28cf50cb.js";import{T as Ee}from"./Table.0f250c54.js";import{T as Be}from"./index.80b03ff6.js";import{C as ve}from"./index.b49e554d.js";import{R as W}from"./index.73b9363b.js";import{U as De}from"./UploadOutlined.7163aa69.js";import{A as ee}from"./index.d2a70782.js";import{D as Ie}from"./index.5b6863d3.js";import"./styleChecker.a749ab9f.js";import"./addEventListener.86688d62.js";import"./useBreakpoint.af3dba42.js";import"./Pagination.6eff48af.js";import"./index.e61d77eb.js";import"./index.cfa22aab.js";import"./EditOutlined.656bce74.js";import"./index.2f1f65ab.js";const Ne="_header_17cy8_1",we="_name_17cy8_6",R={header:Ne,name:we,"form-tabs":"_form-tabs_17cy8_17"},Q=oe.forwardRef(({formId:N,formList:B},v)=>{const[p]=P.useForm(),w={labelCol:{span:4},wrapperCol:{span:12},autoComplete:"off"};h.exports.useEffect(()=>{(async()=>{const e=B.reduce((r,t)=>{t.type==="privateKey"&&t.value?L({...b,[t.field]:{publicKey:t.value}}):["imageUpload"].includes(t.type)?D({...y,[t.field]:t.value}):["fileUpload"].includes(t.type)&&x({...i,[t.field]:t.value});let u=t.value;return t.type==="dateTime"&&t.value?u=U(t.value):t.type==="switch"&&!t.value&&(u=!1),{...r,[t.field]:u}},{});p.setFieldsValue(e)})()},[]);const[y,D]=h.exports.useState({}),M=(e,r)=>{new Promise(t=>{ce(e.file,u=>{t(u)})}).then(t=>{const u=t.substring(t.indexOf("base64,")+7),c={uid:e.file.uid,name:e.file.name,status:"done",url:`data:image/png;base64,${u}`};p.setFieldValue(r,y[r]?[...y[r],c]:[c]),D({...y,[r]:y[r]?[...y[r],c]:[c]})})},n=(e,r)=>{const{uid:t}=e;return p.setFieldValue(r,y[r].filter(u=>u.uid!==t)),D({...y,[r]:y[r].filter(u=>u.uid!==t)}),!1},[_,V]=h.exports.useState(!1),[$,E]=h.exports.useState(),q=e=>{E(e.url),V(!0)},[k,K]=te.useMessage(),[i,x]=h.exports.useState({}),J=(e,r)=>{const{name:t}=e,u=t.substring(t.lastIndexOf(".")+1),l=r.ruleList.includes(u);return l||k.error(`\u4E0D\u652F\u6301\u4E0A\u4F20${u}\u683C\u5F0F\u6587\u4EF6`),l||z.LIST_IGNORE};let C;const Y=async(e,r)=>{const t=new FormData,{file:u}=e;t.append("file",u);try{const{data:l}=await de(t),{fileName:c,url:m}=l;C={uid:e.file.uid,name:c,status:"done",url:m}}catch(l){console.log("error",l),C={uid:e.file.uid,name:e.file.name,status:"error",url:""}}finally{p.setFieldValue(r,i[r]?[...i[r],C]:[C]),x({...i,[r]:i[r]?[...i[r],C]:[C]})}},T=(e,r)=>{const{uid:t}=e;return p.setFieldValue(r,i[r].filter(u=>u.uid!==t)),x({...i,[r]:i[r].filter(u=>u.uid!==t)}),!1},[b,L]=h.exports.useState(),s=async e=>{const{data:r}=await fe();if(!r)return;const{publicKey:t,privateKey:u}=r;L({...b,[e]:{publicKey:t,privateKey:u}}),p.setFieldValue(e,t),pe(u,"\u5BC6\u94A5\u5BF9")},[o,F]=h.exports.useState();h.exports.useEffect(()=>{const e=B.find(t=>t.type==="table");if(!e)return;const r=e.tableOptions.map((t,u)=>{const l=e.value&&e.value[u];return{...t,value:l==null?void 0:l.value}});F(r)},[]);const d=(e,r)=>{const{id:t}=r,u={id:t,value:e},l=o.findIndex(m=>m.id===t);if(l===-1)return;const c=p.getFieldValue("upEndTime");if(c)c[l]=u,p.setFieldValue("upEndTime",c);else{const m=Array(o==null?void 0:o.length);m[l]=u,p.setFieldValue("upEndTime",m)}},g=[{title:"\u63A5\u53E3\u540D\u79F0",width:200,dataIndex:"key"},{title:"\u8C03\u7528\u5E76\u53D1\u4E0A\u9650\uFF08\u6BCF\u79D2\u5E76\u53D1\uFF09",render:e=>a(A,{children:a(H,{defaultValue:e.value,placeholder:"\u8BF7\u9009\u62E9\u8C03\u7528\u5E76\u53D1\u4E0A\u9650\uFF08\u6BCF\u79D2\u5E76\u53D1\uFF09",options:e.options,onChange:r=>d(r,e)})})}];return f(A,{children:[K,a(P,{ref:v,form:p,name:N.toString(),...w,children:B.map(e=>a(P.Item,{noStyle:["imageUpload","fileUpload"].includes(e.type),name:["imageUpload","fileUpload"].includes(e.type)?void 0:e.field,label:!["imageUpload","fileUpload"].includes(e.type)&&e.cnName,rules:[{required:e.required,message:`${["dateTime","radio","checkbox","select","selectMultiple","table"].includes(e.type)?"\u8BF7\u9009\u62E9":"\u8BF7\u8F93\u5165"}${e.cnName}`},{validator(r,t){return e.type==="table"&&t&&t.some(l=>!l)?Promise.reject(new Error("\u8BF7\u5F55\u5165\u6240\u6709\u8C03\u7528\u5E76\u53D1\u4E0A\u9650")):Promise.resolve()}}],valuePropName:["switch","checkbox"].includes(e.type)?"checked":void 0,children:(()=>{var r,t;switch(e.type){case"text":return a(Z,{placeholder:e.placeholder,maxLength:e.maxLength,showCount:!0});case"textarea":return a(Z.TextArea,{placeholder:e.placeholder,maxLength:e.maxLength,showCount:!0});case"dateTime":return a(Ae,{style:{minWidth:160},placeholder:e.placeholder});case"radio":return a(W.Group,{options:e.options||[]});case"checkbox":return a(ve.Group,{options:e.options||[],defaultValue:e.value});case"select":return a(H,{options:e.options||[],placeholder:e.placeholder});case"selectMultiple":return a(H,{mode:"multiple",allowClear:!0,options:e.options||[],placeholder:e.placeholder});case"switch":return a(ie,{options:e.options||[],placeholder:e.placeholder,checkedChildren:(r=e.switchText)==null?void 0:r.split("/")[0],unCheckedChildren:(t=e.switchText)==null?void 0:t.split("/")[1]});case"imageUpload":return f(A,{children:[a(P.Item,{name:e.field,label:e.label,style:{marginBottom:0},rules:[{required:e.required,message:`\u8BF7\u8865\u5145${e.cnName}`}],children:a(z,{listType:"picture-card",maxCount:1,fileList:y[e.field],beforeUpload:u=>le(u,e.fileSize),customRequest:u=>M(u,e.field),onPreview:q,onRemove:u=>n(u,e.field),children:(!y[e.field]||e.multiple>y[e.field].length)&&f(A,{children:[a(ne,{}),"\u9009\u62E9\u56FE\u7247"]})})}),f(X,{children:[a(S,{span:20,offset:4,className:"font-secondary-color",children:"\u4E0A\u4F20\u56FE\u7247\u53EA\u5141\u8BB8JPG/PNG\u683C\u5F0F"}),f(S,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u56FE\u7247\u6587\u4EF6\u5927\u5C0F\uFF1A",e.fileSize,"M"]}),f(S,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u4E0A\u4F20\u56FE\u7247\u6570\u91CF\uFF1A",e.multiple,"\u5F20"]})]})]});case"fileUpload":return f(A,{children:[a(P.Item,{name:e.field,label:e.label,style:{marginBottom:0},rules:[{required:e.required,message:`\u8BF7\u8865\u5145${e.cnName}`}],children:a(z,{maxCount:1,fileList:i[e.field],beforeUpload:u=>J(u,e),customRequest:u=>Y(u,e.field),onRemove:u=>T(u,e.field),children:a(O,{icon:a(De,{}),disabled:i[e.field]&&e.multiple<=i[e.field].length,children:"\u4E0A\u4F20\u6587\u4EF6"})})}),f(X,{children:[f(S,{span:20,offset:4,className:"font-secondary-color",children:["\u4E0A\u4F20\u6587\u4EF6\u53EA\u5141\u8BB8",e.ruleList.join(),"\u683C\u5F0F"]}),f(S,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u6587\u4EF6\u5927\u5C0F\uFF1A",e.fileSize,"M"]}),f(S,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u4E0A\u4F20\u6587\u4EF6\u6570\u91CF\uFF1A",e.multiple]})]})]});case"privateKey":return f(ue,{children:[a(O,{type:"primary",onClick:()=>s(e.field),children:"\u751F\u6210\u5BC6\u94A5\u5BF9"}),b&&f(A,{children:[a("span",{style:{minWidth:50,display:"inline-block"},children:"\u516C\u94A5\uFF1A"}),a(Be.Paragraph,{copyable:!0,style:{marginBottom:0},children:b[e.field].publicKey})]})]});case"table":return a(A,{children:a(Ee,{rowKey:"id",bordered:!0,dataSource:o,columns:g,pagination:!1})});default:return a(A,{})}})()},e.field))}),a(re,{open:_,footer:null,onCancel:()=>V(!1),children:a("img",{alt:"image",style:{width:"100%"},src:$})})]})});Q.displayName="DynamicForm";const Ge=()=>{const[N]=me(),B=Fe(),v=N.get("appId"),p=Number(N.get("capabilityId")),w=N.get("env");if(!v||!p||!w)return B(-1);const{myAppStore:y}=he();y.setAppId(v);const[D,M]=h.exports.useState(),[n,_]=h.exports.useState(),[V,$]=h.exports.useState(),E=h.exports.useRef();h.exports.useEffect(()=>{(async()=>{const{data:s}=await ye({id:p});M(s)})(),(async()=>{const{data:s}=await ge({appId:v,capabilityId:p,env:w});if(!s)return B(-1);_(s.formList),$(JSON.parse(s.formList[0].defaultFormContent)),k(s.formList[0].formId)})()},[]);const[q,k]=h.exports.useState(0),K=s=>{const o=n.find(F=>F.formId===s.target.value);!o||k(o.formId)},i=h.exports.useRef([]),[x,J]=re.useModal(),[C,Y]=te.useMessage(),T=(s,o)=>{const{type:F}=s;if(["radio","select"].includes(F)){const{options:d}=s;if(!d)return;const g=d.find(e=>e.value===o);return g==null?void 0:g.label}else if(["checkbox","selectMultiple"].includes(F)){const{options:d}=s;if(!d)return;const g=(o==null?void 0:o.reduce((e,r)=>{const t=d.find(l=>l.value===r),u=t?t.label:void 0;return[...e,u]},[]))||void 0;return g?g.toString():void 0}else{if(["dateTime"].includes(F)&&o)return U(o).isValid()&&U(o).format("YYYY-MM-DD");if(["switch"].includes(F)){const{switchText:d}=s;return d?(d==null?void 0:d.split("/"))[+!o]:void 0}else return["table"].includes(F)?s.tableOptions.map((d,g)=>({label:d.key,value:o[g].value})):o}},b=(s,o)=>{if(s==="dateTime")return o&&U(o).isValid()?U(o).format("YYYY-MM-DD"):o;if(s==="fileUpload"&&o){const F=o.filter(d=>d.status==="done");return F.length?F:void 0}else return o},L=async s=>{if(!n)return;if(s)try{await E.current.validateFields();for(let e=0;e<i.current.length;e++)await i.current[e].validateFields()}catch{return C.error("\u8BF7\u6838\u5BF9\u8868\u5355\u5FC5\u586B\u9879\u662F\u5426\u5DF2\u5168\u90E8\u5F55\u5165"),!1}const o=[];for(let e=0;e<(n==null?void 0:n.length);e++){const r=JSON.parse(n[e].formContent),t=r.map(l=>({...l,value:b(l.type,i.current[e].getFieldValue(l.field))}));let u={formContent:JSON.stringify(t),formId:n[e].formId,formName:n[e].formName};if(e===0){const c=JSON.parse(n[0].defaultFormContent).map(m=>({...m,labelValue:T(m,E.current.getFieldValue(m.field)),value:b(m.type,E.current.getFieldValue(m.field))}));u.defaultFormContent=JSON.stringify(c)}if(s){const l=r.map(c=>{const{cnName:m,dataType:I,type:j,field:G}=c;return{cnName:m,dataType:I,type:j,field:G,labelValue:T(c,i.current[e].getFieldValue(c.field)),value:b(c.type,i.current[e].getFieldValue(c.field))}});if(e===0){const m=JSON.parse(n[0].defaultFormContent).map(I=>{const{cnName:j,dataType:G,type:ae,field:se}=I;return{cnName:j,dataType:G,type:ae,field:se,labelValue:T(I,E.current.getFieldValue(I.field)),value:b(I.type,E.current.getFieldValue(I.field))}});u.defaultFormList=m}u={...u,form:l}}o.push(u)}if(!await x.confirm({title:`${s?"\u63D0\u4EA4\u5BA1\u6838":"\u4FDD\u5B58\u8349\u7A3F"}`,content:`${s?"\u63D0\u4EA4\u5BA1\u6838\u540E\u4F1A\u8FDB\u5165\u5BA1\u6279\u9636\u6BB5\uFF0C\u8BF7\u786E\u8BA4\u662F\u5426\u63D0\u4EA4":"\u4FDD\u5B58\u8349\u7A3F\u4F1A\u8986\u76D6\u4E0A\u4E00\u6B21\u4FDD\u5B58\u7684\u5185\u5BB9\uFF0C\u662F\u5426\u786E\u8BA4\u4FDD\u5B58\uFF1F"}`}))return;const d=!!N.get("isEdit"),g={appId:v,capabilityId:p,formList:o,type:s,env:w};d?await be(g):await Ce(g),C.success({content:`\u5DF2\u6210\u529F${s?"\u63D0\u4EA4\u5BA1\u6838":"\u4FDD\u5B58\u8349\u7A3F"}`,duration:2,onClose:()=>B(-1)})};return f(A,{children:[J,Y,f("div",{className:R.header,children:[a("div",{className:`${R["left-side"]} ${R.name}`,children:D==null?void 0:D.name}),a("div",{className:R["right-side"],children:a(ee,{offsetTop:80,children:f(ue,{children:[a(O,{onClick:()=>L(0),children:"\u4FDD\u5B58\u8349\u7A3F"}),a(O,{type:"primary",onClick:()=>L(1),children:"\u63D0\u4EA4\u5BA1\u6838"})]})})})]}),a(Ie,{}),a("div",{className:R["form-tabs"],children:n&&!!n.length&&a(ee,{offsetTop:80,style:{display:"inline-block"},children:a(W.Group,{size:"large",defaultValue:n[0].formId,buttonStyle:"solid",onChange:K,children:n.map(s=>a(W.Button,{value:s.formId,children:s.formName},s.formId))})})}),v&&w&&p&&n&&!!n.length&&n.map((s,o)=>f("div",{style:{display:q===s.formId?"block":"none"},children:[!o&&V&&a(Q,{ref:E,formId:"defaultForm",formList:V}),a(Q,{ref:F=>i.current[o]=F,formId:s.formId,formList:JSON.parse(s.formContent)})]},s.formId))]})};export{Ge as default};
