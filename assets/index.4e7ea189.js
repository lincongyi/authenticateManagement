import{R as oe,F as w,r as F,m as te,a as f,d as C,j as r,b as ae,B as M,U as z,c as X,C as N,i as le,e as ne,c1 as ie,S as H,I as Z,M as ue,bH as ce,c2 as de,c3 as fe,c4 as pe,b4 as me,aI as Fe,u as he}from"./index.15d8fadb.js";import{a as ye,c as ge,d as Ce,e as be}from"./ability.b20ce4a3.js";import{d as V,D as Ae}from"./zh-cn.469d9513.js";import{T as Ee}from"./Table.c55fa497.js";import{T as ve}from"./index.a1a67c16.js";import{C as Be}from"./index.a33b29c5.js";import{R as W}from"./index.9657870a.js";import{U as De}from"./UploadOutlined.3ecce806.js";import{A as ee}from"./index.882b3568.js";import{D as Ie}from"./index.f6be2dfc.js";import"./styleChecker.c8992af2.js";import"./addEventListener.f534b669.js";import"./useBreakpoint.4aa98d4c.js";import"./Pagination.fb05f7d1.js";import"./index.fd493ef3.js";import"./index.6c5ff670.js";import"./EditOutlined.7a85110d.js";import"./index.aec99326.js";const Ne="_header_17cy8_1",Se="_name_17cy8_6",x={header:Ne,name:Se,"form-tabs":"_form-tabs_17cy8_17"},Q=oe.forwardRef(({formId:T,formList:b},A)=>{const[d]=w.useForm(),_={labelCol:{span:4},wrapperCol:{span:12},autoComplete:"off"};F.exports.useEffect(()=>{(async()=>{const e=b.reduce((u,t)=>{t.type==="privateKey"&&t.value?D({...B,[t.field]:{publicKey:t.value}}):["imageUpload"].includes(t.type)?S({...p,[t.field]:t.value}):["fileUpload"].includes(t.type)&&g({...y,[t.field]:t.value});let a=t.value;return t.type==="dateTime"&&t.value?a=V(t.value):t.type==="switch"&&!t.value&&(a=!1),{...u,[t.field]:a}},{});d.setFieldsValue(e)})()},[]);const[p,S]=F.exports.useState({}),i=(e,u)=>{new Promise(t=>{ce(e.file,a=>{t(a)})}).then(t=>{const a=t.substring(t.indexOf("base64,")+7),n={uid:e.file.uid,name:e.file.name,status:"done",url:`data:image/png;base64,${a}`};d.setFieldValue(u,p[u]?[...p[u],n]:[n]),S({...p,[u]:p[u]?[...p[u],n]:[n]})})},$=(e,u)=>{const{uid:t}=e;d.setFieldValue(u,p[u].filter(a=>a.uid!==t)),S({...p,[u]:p[u].filter(a=>a.uid!==t)})},[L,P]=F.exports.useState(!1),[E,R]=F.exports.useState(),q=e=>{R(e.url),P(!0)},[K,U]=te.useMessage(),[y,g]=F.exports.useState({}),J=(e,u)=>{const{name:t}=e,a=t.substring(t.lastIndexOf(".")+1),l=u.ruleList.includes(a);return l||K.error(`\u4E0D\u652F\u6301\u4E0A\u4F20${a}\u683C\u5F0F\u6587\u4EF6`),l||z.LIST_IGNORE};let v;const k=async(e,u)=>{const t=new FormData,{file:a}=e;t.append("file",a);try{const{data:l}=await de(t),{fileName:n,url:m}=l;v={uid:e.file.uid,name:n,status:"done",url:m}}catch(l){console.log("error",l),v={uid:e.file.uid,name:e.file.name,status:"error",url:""}}finally{d.setFieldValue(u,y[u]?[...y[u],v]:[v]),g({...y,[u]:y[u]?[...y[u],v]:[v]})}},Y=(e,u)=>{const{uid:t}=e;d.setFieldValue(u,y[u].filter(a=>a.uid!==t)),g({...y,[u]:y[u].filter(a=>a.uid!==t)})},[B,D]=F.exports.useState(),O=async e=>{const{data:u}=await fe();if(!u)return;const{publicKey:t,privateKey:a}=u;D({...B,[e]:{publicKey:t,privateKey:a}}),d.setFieldValue(e,t),pe(a,"\u5BC6\u94A5\u5BF9")},[s,o]=F.exports.useState();F.exports.useEffect(()=>{const e=b.find(t=>t.type==="table");if(!e)return;const u=e.tableOptions.map((t,a)=>{const l=e.value&&e.value[a];return{...t,value:l==null?void 0:l.value}});o(u)},[]);const h=(e,u)=>{const{id:t}=u,a={id:t,value:e},l=s.findIndex(m=>m.id===t);if(l===-1)return;const n=d.getFieldValue("upEndTime");if(n)n[l]=a,d.setFieldValue("upEndTime",n);else{const m=Array(s==null?void 0:s.length);m[l]=a,d.setFieldValue("upEndTime",m)}},c=[{title:"\u63A5\u53E3\u540D\u79F0",width:200,dataIndex:"key"},{title:"\u8C03\u7528\u5E76\u53D1\u4E0A\u9650\uFF08\u6BCF\u79D2\u5E76\u53D1\uFF09",render:e=>r(C,{children:r(H,{defaultValue:e.value,placeholder:"\u8BF7\u9009\u62E9\u8C03\u7528\u5E76\u53D1\u4E0A\u9650\uFF08\u6BCF\u79D2\u5E76\u53D1\uFF09",options:e.options,onChange:u=>h(u,e)})})}];return f(C,{children:[U,r(w,{ref:A,form:d,name:T.toString(),..._,children:b.map(e=>r(w.Item,{noStyle:["imageUpload","fileUpload"].includes(e.type),name:["imageUpload","fileUpload"].includes(e.type)?void 0:e.field,label:!["imageUpload","fileUpload"].includes(e.type)&&e.cnName,rules:[{required:e.required,message:`${["dateTime","radio","checkbox","select","selectMultiple","table"].includes(e.type)?"\u8BF7\u9009\u62E9":"\u8BF7\u8F93\u5165"}${e.cnName}`},{validator(u,t){return e.type==="table"&&t&&t.some(l=>!l)?Promise.reject(new Error("\u8BF7\u5F55\u5165\u6240\u6709\u8C03\u7528\u5E76\u53D1\u4E0A\u9650")):Promise.resolve()}}],valuePropName:["switch","checkbox"].includes(e.type)?"checked":void 0,children:(()=>{var u,t;switch(e.type){case"text":return r(Z,{placeholder:e.placeholder,maxLength:e.maxLength,showCount:!0});case"textarea":return r(Z.TextArea,{placeholder:e.placeholder,maxLength:e.maxLength,showCount:!0});case"dateTime":return r(Ae,{style:{minWidth:160},placeholder:e.placeholder});case"radio":return r(W.Group,{options:e.options||[]});case"checkbox":return r(Be.Group,{options:e.options||[],defaultValue:e.value});case"select":return r(H,{options:e.options||[],placeholder:e.placeholder});case"selectMultiple":return r(H,{mode:"multiple",allowClear:!0,options:e.options||[],placeholder:e.placeholder});case"switch":return r(ie,{options:e.options||[],placeholder:e.placeholder,checkedChildren:(u=e.switchText)==null?void 0:u.split("/")[0],unCheckedChildren:(t=e.switchText)==null?void 0:t.split("/")[1]});case"imageUpload":return f(C,{children:[r(w.Item,{name:e.field,label:e.label,style:{marginBottom:0},rules:[{required:e.required,message:`\u8BF7\u8865\u5145${e.cnName}`}],children:r(z,{listType:"picture-card",maxCount:1,fileList:p[e.field],beforeUpload:a=>le(a,e.fileSize),customRequest:a=>i(a,e.field),onPreview:q,onRemove:a=>$(a,e.field),children:(!p[e.field]||e.multiple>p[e.field].length)&&f(C,{children:[r(ne,{}),"\u9009\u62E9\u56FE\u7247"]})})}),f(X,{children:[r(N,{span:20,offset:4,className:"font-secondary-color",children:"\u4E0A\u4F20\u56FE\u7247\u53EA\u5141\u8BB8JPG/PNG\u683C\u5F0F"}),f(N,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u56FE\u7247\u6587\u4EF6\u5927\u5C0F\uFF1A",e.fileSize,"M"]}),f(N,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u4E0A\u4F20\u56FE\u7247\u6570\u91CF\uFF1A",e.multiple,"\u5F20"]})]})]});case"fileUpload":return f(C,{children:[r(w.Item,{name:e.field,label:e.label,style:{marginBottom:0},rules:[{required:e.required,message:`\u8BF7\u8865\u5145${e.cnName}`}],children:r(z,{maxCount:e.multiple,fileList:y[e.field],beforeUpload:a=>J(a,e),customRequest:a=>k(a,e.field),onRemove:a=>Y(a,e.field),children:r(M,{icon:r(De,{}),disabled:y[e.field]&&e.multiple<=y[e.field].length,children:"\u4E0A\u4F20\u6587\u4EF6"})})}),f(X,{children:[f(N,{span:20,offset:4,className:"font-secondary-color",children:["\u4E0A\u4F20\u56FE\u7247\u53EA\u5141\u8BB8",e.ruleList.join(),"\u683C\u5F0F"]}),f(N,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u6587\u4EF6\u5927\u5C0F\uFF1A",e.fileSize,"M"]}),f(N,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u4E0A\u4F20\u6587\u4EF6\u6570\u91CF\uFF1A",e.multiple]})]})]});case"privateKey":return f(ae,{children:[r(M,{type:"primary",onClick:()=>O(e.field),children:"\u751F\u6210\u5BC6\u94A5\u5BF9"}),B&&f(C,{children:[r("span",{style:{minWidth:50,display:"inline-block"},children:"\u516C\u94A5\uFF1A"}),r(ve.Paragraph,{copyable:!0,style:{marginBottom:0},children:B[e.field].publicKey})]})]});case"table":return r(C,{children:r(Ee,{rowKey:"id",bordered:!0,dataSource:s,columns:c,pagination:!1})});default:return r(C,{})}})()},e.field))}),r(ue,{open:L,footer:null,onCancel:()=>P(!1),children:r("img",{alt:"image",style:{width:"100%"},src:E})})]})});Q.displayName="DynamicForm";const Ge=()=>{const[T]=me(),b=Fe(),A=T.get("appId"),d=Number(T.get("capabilityId"));if(!A||!d)return b(-1);const{myAppStore:_}=he();_.setAppId(A);const[p,S]=F.exports.useState(),[i,$]=F.exports.useState(),[L,P]=F.exports.useState(),E=F.exports.useRef(),[R,q]=F.exports.useState();F.exports.useEffect(()=>{(async()=>{const{data:s}=await ye({id:d});S(s)})(),(async()=>{const{data:s}=await ge({appId:A,capabilityId:d});if(!s)return b(-1);q(s.env);const o=await Ce({appId:A,capabilityId:d,env:s.env});if(!o.data)return b(-1);$(o.data.formList),P(JSON.parse(o.data.formList[0].defaultFormContent)),U(o.data.formList[0].formId)})()},[]);const[K,U]=F.exports.useState(0),y=s=>{const o=i.find(h=>h.formId===s.target.value);!o||U(o.formId)},g=F.exports.useRef([]),[J,v]=ue.useModal(),[k,Y]=te.useMessage(),B=(s,o)=>{const{type:h}=s;if(["radio","select"].includes(h)){const{options:c}=s;if(!c)return;const e=c.find(u=>u.value===o);return e==null?void 0:e.label}else if(["checkbox","selectMultiple"].includes(h)){const{options:c}=s;if(!c)return;const e=(o==null?void 0:o.reduce((u,t)=>{const a=c==null?void 0:c.find(n=>n.value===t),l=a?a.label:void 0;return[...u,l]},[]))||void 0;return e?e.toString():void 0}else{if(["dateTime"].includes(h)&&o)return V(o).isValid()&&V(o).format("YYYY-MM-DD");if(["switch"].includes(h)){const{switchText:c}=s;return c?(c==null?void 0:c.split("/"))[+!o]:void 0}else return["table"].includes(h)?s.tableOptions.map((c,e)=>({label:c.key,value:o[e].value})):o}},D=(s,o)=>{if(s==="dateTime")return o&&V(o).isValid()?V(o).format("YYYY-MM-DD"):o;if(s==="fileUpload"&&o){const h=o.filter(c=>c.status==="done");return h.length?h:void 0}else return o},O=async s=>{if(!i)return;if(s)try{await E.current.validateFields();for(let e=0;e<g.current.length;e++)await g.current[e].validateFields()}catch{return k.error("\u8BF7\u6838\u5BF9\u8868\u5355\u5FC5\u586B\u9879\u662F\u5426\u5DF2\u5168\u90E8\u5F55\u5165"),!1}const o=[];for(let e=0;e<(i==null?void 0:i.length);e++){const u=JSON.parse(i[e].formContent),t=u.map(l=>({...l,value:D(l.type,g.current[e].getFieldValue(l.field))}));let a={formContent:JSON.stringify(t),formId:i[e].formId,formName:i[e].formName};if(e===0){const n=JSON.parse(i[0].defaultFormContent).map(m=>({...m,labelValue:B(m,E.current.getFieldValue(m.field)),value:D(m.type,E.current.getFieldValue(m.field))}));a.defaultFormContent=JSON.stringify(n)}if(s){const l=u.map(n=>{const{cnName:m,dataType:I,type:j,field:G}=n;return{cnName:m,dataType:I,type:j,field:G,labelValue:B(n,g.current[e].getFieldValue(n.field)),value:D(n.type,g.current[e].getFieldValue(n.field))}});if(e===0){const m=JSON.parse(i[0].defaultFormContent).map(I=>{const{cnName:j,dataType:G,type:re,field:se}=I;return{cnName:j,dataType:G,type:re,field:se,labelValue:B(I,E.current.getFieldValue(I.field)),value:D(I.type,E.current.getFieldValue(I.field))}});a.defaultFormList=m}a={...a,form:l}}o.push(a)}if(!await J.confirm({title:`${s?"\u63D0\u4EA4\u5BA1\u6838":"\u4FDD\u5B58\u8349\u7A3F"}`,content:`${s?"\u63D0\u4EA4\u5BA1\u6838\u540E\u4F1A\u8FDB\u5165\u5BA1\u6279\u9636\u6BB5\uFF0C\u8BF7\u786E\u8BA4\u662F\u5426\u63D0\u4EA4":"\u4FDD\u5B58\u8349\u7A3F\u4F1A\u8986\u76D6\u4E0A\u4E00\u6B21\u4FDD\u5B58\u7684\u5185\u5BB9\uFF0C\u662F\u5426\u786E\u8BA4\u4FDD\u5B58\uFF1F"}`}))return;await be({appId:A,capabilityId:d,formList:o,type:s,env:R}),k.success({content:`\u5DF2\u6210\u529F${s?"\u63D0\u4EA4\u5BA1\u6838":"\u4FDD\u5B58\u8349\u7A3F"}`,duration:2,onClose:()=>b(-1)})};return f(C,{children:[v,Y,f("div",{className:x.header,children:[r("div",{className:`${x["left-side"]} ${x.name}`,children:p==null?void 0:p.name}),r("div",{className:x["right-side"],children:r(ee,{offsetTop:80,children:f(ae,{children:[r(M,{onClick:()=>O(0),children:"\u4FDD\u5B58\u8349\u7A3F"}),r(M,{type:"primary",onClick:()=>O(1),children:"\u63D0\u4EA4\u5BA1\u6838"})]})})})]}),r(Ie,{}),r("div",{className:x["form-tabs"],children:i&&!!i.length&&r(ee,{offsetTop:80,style:{display:"inline-block"},children:r(W.Group,{size:"large",defaultValue:i[0].formId,buttonStyle:"solid",onChange:y,children:i.map(s=>r(W.Button,{value:s.formId,children:s.formName},s.formId))})})}),A&&R&&d&&i&&!!i.length&&i.map((s,o)=>f("div",{style:{display:K===s.formId?"block":"none"},children:[!o&&L&&r(Q,{ref:E,formId:"defaultForm",formList:L}),r(Q,{ref:h=>g.current[o]=h,formId:s.formId,formList:JSON.parse(s.formContent)})]},s.formId))]})};export{Ge as default};
