import{R as se,F as L,r as h,m as ee,a as p,d as A,j as a,b as te,B as k,U as G,c as Q,C as N,i as oe,e as le,c5 as ne,S as z,I as X,M as ue,bI as ie,c6 as ce,c7 as de,c8 as fe,b4 as pe,aI as me,u as Fe}from"./index.14298e89.js";import{a as he,c as ye,d as ge}from"./ability.84fb2623.js";import{d as R,D as Ce}from"./zh-cn.1511121d.js";import{T as be}from"./Table.bd8b2932.js";import{T as Ae}from"./index.e67cbb4b.js";import{C as Ee}from"./index.36c87670.js";import{R as H}from"./index.9edbf705.js";import{U as Be}from"./UploadOutlined.e179f868.js";import{A as Z}from"./index.18ce0769.js";import{D as ve}from"./index.991aeac8.js";import"./styleChecker.62977579.js";import"./addEventListener.84422044.js";import"./useBreakpoint.699507aa.js";import"./Pagination.932b8b7f.js";import"./index.1bf58a11.js";import"./index.e87b519f.js";import"./EditOutlined.bda9e335.js";import"./index.91e6bc17.js";const De="_header_17cy8_1",Ie="_name_17cy8_6",P={header:De,name:Ie,"form-tabs":"_form-tabs_17cy8_17"},W=se.forwardRef(({formId:S,formList:B},v)=>{const[m]=L.useForm(),I={labelCol:{span:4},wrapperCol:{span:12},autoComplete:"off"};h.exports.useEffect(()=>{(async()=>{const e=B.reduce((r,t)=>{t.type==="privateKey"&&t.value?T({...b,[t.field]:{publicKey:t.value}}):["imageUpload"].includes(t.type)?D({...y,[t.field]:t.value}):["fileUpload"].includes(t.type)&&V({...d,[t.field]:t.value});let u=t.value;return t.type==="dateTime"&&t.value?u=R(t.value):t.type==="switch"&&!t.value&&(u=!1),{...r,[t.field]:u}},{});m.setFieldsValue(e)})()},[]);const[y,D]=h.exports.useState({}),O=(e,r)=>{new Promise(t=>{ie(e.file,u=>{t(u)})}).then(t=>{const u=t.substring(t.indexOf("base64,")+7),i={uid:e.file.uid,name:e.file.name,status:"done",url:`data:image/png;base64,${u}`};m.setFieldValue(r,y[r]?[...y[r],i]:[i]),D({...y,[r]:y[r]?[...y[r],i]:[i]})})},c=(e,r)=>{const{uid:t}=e;m.setFieldValue(r,y[r].filter(u=>u.uid!==t)),D({...y,[r]:y[r].filter(u=>u.uid!==t)})},[M,w]=h.exports.useState(!1),[_,E]=h.exports.useState(),$=e=>{E(e.url),w(!0)},[U,q]=ee.useMessage(),[d,V]=h.exports.useState({}),K=(e,r)=>{const{name:t}=e,u=t.substring(t.lastIndexOf(".")+1),l=r.ruleList.includes(u);return l||U.error(`\u4E0D\u652F\u6301\u4E0A\u4F20${u}\u683C\u5F0F\u6587\u4EF6`),l||G.LIST_IGNORE};let C;const J=async(e,r)=>{const t=new FormData,{file:u}=e;t.append("file",u);try{const{data:l}=await ce(t),{fileName:i,url:g}=l;C={uid:e.file.uid,name:i,status:"done",url:g}}catch(l){console.log("error",l),C={uid:e.file.uid,name:e.file.name,status:"error",url:""}}finally{m.setFieldValue(r,d[r]?[...d[r],C]:[C]),V({...d,[r]:d[r]?[...d[r],C]:[C]})}},x=(e,r)=>{const{uid:t}=e;m.setFieldValue(r,d[r].filter(u=>u.uid!==t)),V({...d,[r]:d[r].filter(u=>u.uid!==t)})},[b,T]=h.exports.useState(),s=async e=>{const{data:r}=await de();if(!r)return;const{publicKey:t,privateKey:u}=r;T({...b,[e]:{publicKey:t,privateKey:u}}),m.setFieldValue(e,t),fe(u,"\u5BC6\u94A5\u5BF9")},[o,F]=h.exports.useState();h.exports.useEffect(()=>{const e=B.find(t=>t.type==="table");if(!e)return;const r=e.tableOptions.map((t,u)=>{const l=e.value&&e.value[u];return{...t,value:l==null?void 0:l.value}});F(r)},[]);const f=(e,r)=>{const{id:t}=r,u={id:t,value:e},l=o.findIndex(g=>g.id===t);if(l===-1)return;const i=m.getFieldValue("upEndTime");if(i)i[l]=u,m.setFieldValue("upEndTime",i);else{const g=Array(o==null?void 0:o.length);g[l]=u,m.setFieldValue("upEndTime",g)}},n=[{title:"\u63A5\u53E3\u540D\u79F0",width:200,dataIndex:"key"},{title:"\u8C03\u7528\u5E76\u53D1\u4E0A\u9650\uFF08\u6BCF\u79D2\u5E76\u53D1\uFF09",render:e=>a(A,{children:a(z,{defaultValue:e.value,placeholder:"\u8BF7\u9009\u62E9\u8C03\u7528\u5E76\u53D1\u4E0A\u9650\uFF08\u6BCF\u79D2\u5E76\u53D1\uFF09",options:e.options,onChange:r=>f(r,e)})})}];return p(A,{children:[q,a(L,{ref:v,form:m,name:S.toString(),...I,children:B.map(e=>a(L.Item,{noStyle:["imageUpload","fileUpload"].includes(e.type),name:["imageUpload","fileUpload"].includes(e.type)?void 0:e.field,label:!["imageUpload","fileUpload"].includes(e.type)&&e.cnName,rules:[{required:e.required,message:`${["dateTime","radio","checkbox","select","selectMultiple","table"].includes(e.type)?"\u8BF7\u9009\u62E9":"\u8BF7\u8F93\u5165"}${e.cnName}`},{validator(r,t){return e.type==="table"&&t&&t.some(l=>!l)?Promise.reject(new Error("\u8BF7\u5F55\u5165\u6240\u6709\u8C03\u7528\u5E76\u53D1\u4E0A\u9650")):Promise.resolve()}}],valuePropName:["switch","checkbox"].includes(e.type)?"checked":void 0,children:(()=>{var r,t;switch(e.type){case"text":return a(X,{placeholder:e.placeholder,maxLength:e.maxLength,showCount:!0});case"textarea":return a(X.TextArea,{placeholder:e.placeholder,maxLength:e.maxLength,showCount:!0});case"dateTime":return a(Ce,{style:{minWidth:160},placeholder:e.placeholder});case"radio":return a(H.Group,{options:e.options||[]});case"checkbox":return a(Ee.Group,{options:e.options||[],defaultValue:e.value});case"select":return a(z,{options:e.options||[],placeholder:e.placeholder});case"selectMultiple":return a(z,{mode:"multiple",allowClear:!0,options:e.options||[],placeholder:e.placeholder});case"switch":return a(ne,{options:e.options||[],placeholder:e.placeholder,checkedChildren:(r=e.switchText)==null?void 0:r.split("/")[0],unCheckedChildren:(t=e.switchText)==null?void 0:t.split("/")[1]});case"imageUpload":return p(A,{children:[a(L.Item,{name:e.field,label:e.label,style:{marginBottom:0},rules:[{required:e.required,message:`\u8BF7\u8865\u5145${e.cnName}`}],children:a(G,{listType:"picture-card",maxCount:1,fileList:y[e.field],beforeUpload:u=>oe(u,e.fileSize),customRequest:u=>O(u,e.field),onPreview:$,onRemove:u=>c(u,e.field),children:(!y[e.field]||e.multiple>y[e.field].length)&&p(A,{children:[a(le,{}),"\u9009\u62E9\u56FE\u7247"]})})}),p(Q,{children:[a(N,{span:20,offset:4,className:"font-secondary-color",children:"\u4E0A\u4F20\u56FE\u7247\u53EA\u5141\u8BB8JPG/PNG\u683C\u5F0F"}),p(N,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u56FE\u7247\u6587\u4EF6\u5927\u5C0F\uFF1A",e.fileSize,"M"]}),p(N,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u4E0A\u4F20\u56FE\u7247\u6570\u91CF\uFF1A",e.multiple,"\u5F20"]})]})]});case"fileUpload":return p(A,{children:[a(L.Item,{name:e.field,label:e.label,style:{marginBottom:0},rules:[{required:e.required,message:`\u8BF7\u8865\u5145${e.cnName}`}],children:a(G,{maxCount:1,fileList:d[e.field],beforeUpload:u=>K(u,e),customRequest:u=>J(u,e.field),onRemove:u=>x(u,e.field),children:a(k,{icon:a(Be,{}),disabled:d[e.field]&&e.multiple<=d[e.field].length,children:"\u4E0A\u4F20\u6587\u4EF6"})})}),p(Q,{children:[p(N,{span:20,offset:4,className:"font-secondary-color",children:["\u4E0A\u4F20\u6587\u4EF6\u53EA\u5141\u8BB8",e.ruleList.join(),"\u683C\u5F0F"]}),p(N,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u6587\u4EF6\u5927\u5C0F\uFF1A",e.fileSize,"M"]}),p(N,{span:20,offset:4,className:"font-secondary-color",children:["\u652F\u6301\u4E0A\u4F20\u6587\u4EF6\u6570\u91CF\uFF1A",e.multiple]})]})]});case"privateKey":return p(te,{children:[a(k,{type:"primary",onClick:()=>s(e.field),children:"\u751F\u6210\u5BC6\u94A5\u5BF9"}),b&&p(A,{children:[a("span",{style:{minWidth:50,display:"inline-block"},children:"\u516C\u94A5\uFF1A"}),a(Ae.Paragraph,{copyable:!0,style:{marginBottom:0},children:b[e.field].publicKey})]})]});case"table":return a(A,{children:a(be,{rowKey:"id",bordered:!0,dataSource:o,columns:n,pagination:!1})});default:return a(A,{})}})()},e.field))}),a(ue,{open:M,footer:null,onCancel:()=>w(!1),children:a("img",{alt:"image",style:{width:"100%"},src:_})})]})});W.displayName="DynamicForm";const Ye=()=>{const[S]=pe(),B=me(),v=S.get("appId"),m=Number(S.get("capabilityId")),I=S.get("env");if(!v||!m||!I)return B(-1);const{myAppStore:y}=Fe();y.setAppId(v);const[D,O]=h.exports.useState(),[c,M]=h.exports.useState(),[w,_]=h.exports.useState(),E=h.exports.useRef();h.exports.useEffect(()=>{(async()=>{const{data:s}=await he({id:m});O(s)})(),(async()=>{const{data:s}=await ye({appId:v,capabilityId:m,env:I});if(!s)return B(-1);M(s.formList),_(JSON.parse(s.formList[0].defaultFormContent)),U(s.formList[0].formId)})()},[]);const[$,U]=h.exports.useState(0),q=s=>{const o=c.find(F=>F.formId===s.target.value);!o||U(o.formId)},d=h.exports.useRef([]),[V,K]=ue.useModal(),[C,J]=ee.useMessage(),x=(s,o)=>{const{type:F}=s;if(["radio","select"].includes(F)){const{options:f}=s;if(!f)return;const n=f.find(e=>e.value===o);return n==null?void 0:n.label}else if(["checkbox","selectMultiple"].includes(F)){const{options:f}=s;if(!f)return;const n=(o==null?void 0:o.reduce((e,r)=>{const t=f.find(l=>l.value===r),u=t?t.label:void 0;return[...e,u]},[]))||void 0;return n?n.toString():void 0}else{if(["dateTime"].includes(F)&&o)return R(o).isValid()&&R(o).format("YYYY-MM-DD");if(["switch"].includes(F)){const{switchText:f}=s;return f?(f==null?void 0:f.split("/"))[+!o]:void 0}else return["table"].includes(F)?s.tableOptions.map((f,n)=>({label:f.key,value:o[n].value})):o}},b=(s,o)=>{if(s==="dateTime")return o&&R(o).isValid()?R(o).format("YYYY-MM-DD"):o;if(s==="fileUpload"&&o){const F=o.filter(f=>f.status==="done");return F.length?F:void 0}else return o},T=async s=>{if(!c)return;if(s)try{await E.current.validateFields();for(let n=0;n<d.current.length;n++)await d.current[n].validateFields()}catch{return C.error("\u8BF7\u6838\u5BF9\u8868\u5355\u5FC5\u586B\u9879\u662F\u5426\u5DF2\u5168\u90E8\u5F55\u5165"),!1}const o=[];for(let n=0;n<(c==null?void 0:c.length);n++){const e=JSON.parse(c[n].formContent),r=e.map(u=>({...u,value:b(u.type,d.current[n].getFieldValue(u.field))}));let t={formContent:JSON.stringify(r),formId:c[n].formId,formName:c[n].formName};if(n===0){const l=JSON.parse(c[0].defaultFormContent).map(i=>({...i,labelValue:x(i,E.current.getFieldValue(i.field)),value:b(i.type,E.current.getFieldValue(i.field))}));t.defaultFormContent=JSON.stringify(l)}if(s){const u=e.map(l=>{const{cnName:i,dataType:g,type:Y,field:j}=l;return{cnName:i,dataType:g,type:Y,field:j,labelValue:x(l,d.current[n].getFieldValue(l.field)),value:b(l.type,d.current[n].getFieldValue(l.field))}});if(n===0){const i=JSON.parse(c[0].defaultFormContent).map(g=>{const{cnName:Y,dataType:j,type:re,field:ae}=g;return{cnName:Y,dataType:j,type:re,field:ae,labelValue:x(g,E.current.getFieldValue(g.field)),value:b(g.type,E.current.getFieldValue(g.field))}});t.defaultFormList=i}t={...t,form:u}}o.push(t)}if(!await V.confirm({title:`${s?"\u63D0\u4EA4\u5BA1\u6838":"\u4FDD\u5B58\u8349\u7A3F"}`,content:`${s?"\u63D0\u4EA4\u5BA1\u6838\u540E\u4F1A\u8FDB\u5165\u5BA1\u6279\u9636\u6BB5\uFF0C\u8BF7\u786E\u8BA4\u662F\u5426\u63D0\u4EA4":"\u4FDD\u5B58\u8349\u7A3F\u4F1A\u8986\u76D6\u4E0A\u4E00\u6B21\u4FDD\u5B58\u7684\u5185\u5BB9\uFF0C\u662F\u5426\u786E\u8BA4\u4FDD\u5B58\uFF1F"}`}))return;await ge({appId:v,capabilityId:m,formList:o,type:s,env:I}),C.success({content:`\u5DF2\u6210\u529F${s?"\u63D0\u4EA4\u5BA1\u6838":"\u4FDD\u5B58\u8349\u7A3F"}`,duration:2,onClose:()=>B(-1)})};return p(A,{children:[K,J,p("div",{className:P.header,children:[a("div",{className:`${P["left-side"]} ${P.name}`,children:D==null?void 0:D.name}),a("div",{className:P["right-side"],children:a(Z,{offsetTop:80,children:p(te,{children:[a(k,{onClick:()=>T(0),children:"\u4FDD\u5B58\u8349\u7A3F"}),a(k,{type:"primary",onClick:()=>T(1),children:"\u63D0\u4EA4\u5BA1\u6838"})]})})})]}),a(ve,{}),a("div",{className:P["form-tabs"],children:c&&!!c.length&&a(Z,{offsetTop:80,style:{display:"inline-block"},children:a(H.Group,{size:"large",defaultValue:c[0].formId,buttonStyle:"solid",onChange:q,children:c.map(s=>a(H.Button,{value:s.formId,children:s.formName},s.formId))})})}),v&&I&&m&&c&&!!c.length&&c.map((s,o)=>p("div",{style:{display:$===s.formId?"block":"none"},children:[!o&&w&&a(W,{ref:E,formId:"defaultForm",formList:w}),a(W,{ref:F=>d.current[o]=F,formId:s.formId,formList:JSON.parse(s.formContent)})]},s.formId))]})};export{Ye as default};
